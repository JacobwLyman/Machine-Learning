---
title: "Post-Experiment Analysis for Your Test"
author: "Your Name"
date: "`r format(Sys.time(), '%Y %B %d')`"
output:
  html_document:
    code_folding: hide
    highlight: tango
    number_sections: yes
    theme: lumen
    css: ps_style.css
    toc: yes
    toc_float: yes
---

```{r, echo=FALSE}
htmltools::img(src = knitr::image_uri("PS_logo_F-01.png"), 
               alt = 'logo', 
               align = 'right',
               style = 'position:relative; top:-70px; right:30px; 
               padding:10px; width:250px; float:right;')
```

```{r global_option, message=FALSE, warning=FALSE, include=FALSE}
options(scipen=999)
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
library(seekr)
library(tidyverse)
library(knitr)
library(kableExtra)
library(data.table)
```

I load all of the course data from the `salesforce.opportunity` table.
```{r message=FALSE, warning=FALSE, include=FALSE}
#Load data from database
data <- ImpalaQuery("SELECT 
name
, library_course_id__c
, s3_handle__c
, course_commissioned_date__c
, published_date__c
, royalty_rate__c
, completion_payment_amount__c
, opportunity_owner_full_name__c
, partnership_type__c
FROM salesforce_prod_content.opportunity
WHERE library_course_id__c !='' --if course name is blank then probably a guide
AND course_id__c NOT LIKE '%cancelled%'
ORDER BY course_commissioned_date__c DESC, published_date__c
")
```

From there, I filter by `course_commissioned_date__c` and `published_date__c` to determine the production numbers for the given month of interest.
```{r message=FALSE, warning=FALSE, include=FALSE}
#Separate Published Courses
published_data <- data %>%
  dplyr::filter(published_date__c %like% '2019-10'
                , s3_handle__c != 'michael-teske'
                , s3_handle__c != 'tim-warner'
                , s3_handle__c != 'michael-bender') ####Important Input####

#Separate Commissioned Courses
commissioned_data <- data %>%
  dplyr::filter(course_commissioned_date__c %like% '2019-10'
                , s3_handle__c != 'michael-teske'
                , s3_handle__c != 'tim-warner'
                , s3_handle__c != 'michael-bender') ####Important Input####
```

#Monthly performance Review 

How many courses were commissioned?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
commissioned_count <- nrow(commissioned_data)
commissioned_count
```

What was the average rate?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
commissioned_avg_rate <- mean(commissioned_data$royalty_rate__c, na.rm = TRUE)
commissioned_avg_rate
```

What was the average completion payment?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
commissioned_avg_payout <- mean(commissioned_data$completion_payment_amount__c, na.rm = TRUE)
commissioned_avg_payout
```

Of the courses that were commissioned, what percent was made up of Offer 2?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
lower_rates <- commissioned_data %>%
  filter(royalty_rate__c <= .06)
lower_rates <- lower_rates %>%
  filter(opportunity_owner_full_name__c != "Sean Lowery"
         , opportunity_owner_full_name__c != "Pat Lavelle")
round(nrow(lower_rates)/nrow(commissioned_data),3)
```

How many unique authors accepted Offer 2?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
length(unique(lower_rates$s3_handle__c))
```

#The following chart represents a break down of who is taking the higher option:
```{r message=FALSE, warning=FALSE, include=FALSE}
course_library <- ImpalaQuery("SELECT *
  FROM product_sandbox.course_library_with_tags a
LEFT JOIN
(SELECT library_course_id__c, s3_handle__c
  FROM salesforce_prod_content.opportunity) b
ON a.course_name = b.library_course_id__c")

course_library <- course_library %>% 
  group_by(s3_handle__c) %>% 
  tally()

lower_rates <- merge(x = lower_rates, y = course_library, by = 's3_handle__c', all.x = TRUE)
write.csv(lower_rates, "lower_rates.csv")

lower_rates <- lower_rates %>%
  select(s3_handle__c, n)

lower_rates <- lower_rates %>%
  distinct(s3_handle__c, n)

thisTable <- lower_rates %>%
  group_by(n) %>%
  tally()

thisTable$n <- as.numeric(thisTable$n)
thisTable$nn <- as.numeric(thisTable$nn)

thisTable$nnn <- thisTable$nn/thisTable$n
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(thisTable, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))  ##The n column is courses_published, while nnn is how many authros fit within each bucket
```
```{r message=FALSE, warning=FALSE, include=FALSE}
# #Percentage: How many authors were commissioned total for each bucket?
# length(unique(commissioned_data$s3_handle__c))
# percentage <- merge(commissioned_data, course_library, by = 's3_handle__c', all.x = TRUE)
# 
# percentage <- percentage[,-c(2:7)]
# 
# percentage <- unique(percentage)
# 
# # percentage <- percentage %>%
# #   filter(distinct(s3_handle__c))
# 
# thisTable2 <- percentage %>%
#   group_by(n) %>%
#   tally()
# 
# thisTable2$n <- as.numeric(thisTable2$n)
# thisTable2$nn <- as.numeric(thisTable2$nn)
# 
# thisTable2$nnn <- thisTable2$nn/thisTable2$n
# View(thisTable2)
# 
# sum(thisTable2$nnn)
```

How many courses were published?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
published_count <- nrow(published_data)
published_count
```

What was the average rate?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
published_avg_rate <- mean(published_data$royalty_rate__c, na.rm = TRUE)
published_avg_rate
```

What was the average completion payment?
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
published_avg_payout <- mean(published_data$completion_payment_amount__c, na.rm = TRUE)
published_avg_payout
```

# How are we trending over time?
```{r message=FALSE, warning=FALSE, include=FALSE}
plot_data <- data %>%
  filter(course_commissioned_date__c != '') 
```

### Courses Commissioned MoM 
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
plot_data %>%
  mutate(course_commissioned_date__c = as.Date(course_commissioned_date__c)) %>%
  mutate(course_commissioned_date__c = cut(course_commissioned_date__c, breaks = "month")) %>%
  group_by(course_commissioned_date__c) %>%
  summarise(total = n()) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(course_commissioned_date__c)) %>%
  filter(month > 100) %>%
  ggplot() +
  geom_line(aes(course_commissioned_date__c,total,group=1)) 
```

### Avg. Commissioned Rate MoM
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
plot_data %>%
  mutate(course_commissioned_date__c = as.Date(course_commissioned_date__c)) %>%
  mutate(course_commissioned_date__c = cut(course_commissioned_date__c, breaks = "month")) %>%
  group_by(course_commissioned_date__c) %>%
  summarise(total = mean(royalty_rate__c, na.rm = TRUE)) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(course_commissioned_date__c)) %>%
  filter(month > 100) %>%
  ggplot() +
  geom_line(aes(course_commissioned_date__c,total,group=1))
```

### Course Published MoM
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  group_by(published_date__c) %>%
  summarise(total = n()) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(published_date__c)) %>%
  filter(month > 100) %>%
  ggplot() +
  geom_line(aes(published_date__c,total,group=1))
```


### Avg. Published Rate MoM
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  group_by(published_date__c) %>%
  summarise(total = mean(royalty_rate__c, na.rm = TRUE)) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(published_date__c)) %>%
  filter(month > 100) %>%
  ggplot() +
  geom_line(aes(published_date__c,total,group=1))
```

# How are we trending over time (Omitting conference ingestion)
```{r message=FALSE, warning=FALSE, include=FALSE}
plot_data <- plot_data %>%
  filter(partnership_type__c != 'PS Ingestion'
         ,partnership_type__c != 'PS Creation')
```

### Courses Commissioned MoM 
```{r message=FALSE, warning=FALSE, include=FALSE}
table1 <- plot_data %>%
  mutate(course_commissioned_date__c = as.Date(course_commissioned_date__c)) %>%
  mutate(course_commissioned_date__c = cut(course_commissioned_date__c, breaks = "month")) %>%
  group_by(course_commissioned_date__c) %>%
  summarise(total = n()) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(course_commissioned_date__c)) %>%
  filter(month > 100)
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(table1, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Avg. Commissioned Rate MoM
```{r message=FALSE, warning=FALSE, include=FALSE}
table2 <- plot_data %>%
  mutate(course_commissioned_date__c = as.Date(course_commissioned_date__c)) %>%
  mutate(course_commissioned_date__c = cut(course_commissioned_date__c, breaks = "month")) %>%
  group_by(course_commissioned_date__c) %>%
  summarise(total = mean(royalty_rate__c, na.rm = TRUE)) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(course_commissioned_date__c)) %>%
  filter(month > 100)
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(table2, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Course Published MoM
```{r message=FALSE, warning=FALSE, include=FALSE}
table3 <- plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  group_by(published_date__c) %>%
  summarise(total = n()) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(published_date__c)) %>%
  filter(month > 100)
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(table3, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Avg. Published Rate MoM
```{r message=FALSE, warning=FALSE, include=FALSE}
table4 <- plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  group_by(published_date__c) %>%
  summarise(total = mean(royalty_rate__c, na.rm = TRUE)) %>%
  mutate(total = as.numeric(total)) %>%
  mutate(month = 1:length(published_date__c)) %>%
  filter(month > 100)
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(table4, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Avg. Commissioned Completion Payment
```{r message=FALSE, warning=FALSE, include=FALSE}
table5 <- plot_data %>%
  mutate(course_commissioned_date__c = as.Date(course_commissioned_date__c)) %>%
  mutate(course_commissioned_date__c = cut(course_commissioned_date__c, breaks = "month")) %>%
  group_by(course_commissioned_date__c)  %>%
  summarise(total = mean(completion_payment_amount__c, na.rm = TRUE))
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(table5, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Avg. Published Completion Payment
```{r message=FALSE, warning=FALSE, include=FALSE}
table6 <- plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  group_by(published_date__c) %>%
  summarise(total = mean(completion_payment_amount__c, na.rm = TRUE))
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(table6, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```

# QoQ Numbers

### Courses Commissioned
```{r}

```

### Avg. Commissioned Rate
```{r message=FALSE, warning=FALSE, include=FALSE}
rate_commissioned <- plot_data %>%
  mutate(course_commissioned_date__c = as.Date(course_commissioned_date__c)) %>%
  mutate(course_commissioned_date__c = cut(course_commissioned_date__c, breaks = "month")) %>%
  mutate(quarter = lubridate::quarter(course_commissioned_date__c, with_year = TRUE)) %>%
  group_by(quarter) %>%
  summarise(total = mean(royalty_rate__c, na.rm = TRUE))
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(rate_commissioned, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Courses Published
```{r}

```

### Avg. Published Rate
```{r message=FALSE, warning=FALSE, include=FALSE}
rate_published <- plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  mutate(quarter = lubridate::quarter(published_date__c, with_year = TRUE)) %>%
  group_by(quarter) %>%
  summarise(total = mean(royalty_rate__c, na.rm = TRUE))
```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(rate_published, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```


### Avg. Completion Payment
```{r message=FALSE, warning=FALSE, include=FALSE}
avg_comp_pmt <- plot_data %>%
  filter(published_date__c != '') %>%
  mutate(published_date__c = as.Date(published_date__c)) %>%
  mutate(published_date__c = cut(published_date__c, breaks = "month")) %>%
  mutate(quarter = lubridate::quarter(published_date__c, with_year = TRUE)) %>%
  group_by(quarter) %>%
  summarise(total = mean(completion_payment_amount__c, na.rm = TRUE))

```
```{r message=FALSE, warning=FALSE, include=TRUE, echo=FALSE}
kable(avg_comp_pmt, align = "c") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  kable_styling() %>%
  scroll_box(height = "200px")
```

